@using Microsoft.AspNetCore.Http
@using SHOPIFY1.Extensions
@using SHOPIFY1.Models
@inject IHttpContextAccessor HttpContextAccessor

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Shopify</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/site.css" />
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow">
        <div class="container">
            <a class="navbar-brand text-warning fw-bold" href="/">SHOPIFY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Trang chủ</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="danhMucMenu" data-bs-toggle="dropdown">Danh mục</a>
                        <ul class="dropdown-menu" aria-labelledby="danhMucMenu">
                            @{
                                var categories = ViewBag.Categories as List<DanhMuc> ?? new List<DanhMuc>();
                            }
                            @foreach (var cat in categories)
                            {
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="@cat.MaDm">@cat.TenDm</a></li>
                            }
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/KhuyenMai">Khuyến mãi</a></li>
                </ul>

                <!-- TÌM KIẾM TOÀN TRANG -->
                <form method="get" asp-controller="Product" asp-action="ByCategory" class="d-flex me-3 position-relative" id="globalSearchForm">
                    <input type="text"
                           name="search"
                           class="form-control me-2"
                           placeholder="Tìm sản phẩm..."
                           id="globalSearchInput"
                           value="@ViewBag.Search"
                           autocomplete="off" />
                    <button type="submit" class="btn btn-outline-light">
                        <i class="bi bi-search"></i>
                    </button>

                    <!-- GỢI Ý TÌM KIẾM (AJAX) -->
                    <div id="searchSuggestions"
                         class="position-absolute top-100 start-0 mt-1 bg-white border shadow-sm rounded w-100"
                         style="z-index: 1050; display: none; max-height: 320px; overflow-y: auto;">
                        <ul class="list-group list-group-flush" id="suggestionList"></ul>
                    </div>
                </form>
                <!-- END TÌM KIẾM -->

                <ul class="navbar-nav align-items-center">
                    <!-- Giỏ hàng -->
                    <li class="nav-item me-3">
                        <a class="nav-link position-relative" href="/Cart/Index">
                            <i class="bi bi-cart3 fs-5"></i>
                            @{
                                var cartCount = (HttpContextAccessor.HttpContext.Session.GetObjectFromJson<List<CartItem>>("Cart") ?? new List<CartItem>()).Sum(c => c.SoLuong);
                            }
                            @if (cartCount > 0)
                            {
                                <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" style="font-size: 0.7rem;">@cartCount</span>
                            }
                        </a>
                    </li>

                    <!-- User Menu -->
                    @{
                        var hoTen = HttpContextAccessor.HttpContext.Session.GetString("HoTen");
                        var role = HttpContextAccessor.HttpContext.Session.GetInt32("UserRole");
                    }
                    @if (!string.IsNullOrEmpty(hoTen))
                    {
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-warning" href="#" id="userMenu" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle"></i> @hoTen
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li><a class="dropdown-item" href="/Account/Profile">Thông tin cá nhân</a></li>
                                <li><a class="dropdown-item" href="/Order">Đơn hàng của tôi</a></li>
                                @if (role == 2 || role == 3)
                                {
                                    <li><a class="dropdown-item" href="/Admin/Dashboard">Quản lý</a></li>
                                }
                                <li><hr class="dropdown-divider" /></li>
                                <li><a class="dropdown-item text-danger" href="/Account/Logout"><i class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
                            </ul>
                        </li>
                    }
                    else
                    {
                        <li class="nav-item">
                            <a class="btn btn-outline-light btn-sm me-2" href="/Account/Login">
                                <i class="bi bi-box-arrow-in-right"></i> Đăng nhập
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-warning btn-sm text-dark fw-bold" href="/Account/Register">
                                <i class="bi bi-person-plus"></i> Đăng ký
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding-top: 90px;">
        @RenderBody()
    </main>

    <!-- Footer -->
    <footer class="text-center bg-dark text-light mt-5 py-3">
        <div class="container">
            <p>© 2025 Shopify Electronic Store | Thiết kế bởi <strong>Hoàng Đỗ</strong></p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- AJAX TÌM KIẾM GỢI Ý -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('globalSearchInput');
            const suggestionBox = document.getElementById('searchSuggestions');
            const suggestionList = document.getElementById('suggestionList');
            let debounceTimer;

            searchInput.addEventListener('input', function () {
                clearTimeout(debounceTimer);
                const query = this.value.trim();

                if (query.length < 2) {
                    suggestionBox.style.display = 'none';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`/Product/SearchSuggestions?query=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            suggestionList.innerHTML = '';
                            if (data && data.length > 0) {
                                data.forEach(item => {
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item list-group-item-action';
                                    li.style.cursor = 'pointer';
                                    li.innerHTML = `
                                        <div class="d-flex align-items-center">
                                            <img src="${item.hinhAnh || '/images/no-image.jpg'}" width="40" height="40" class="rounded me-2" />
                                            <div>
                                                <strong>${highlight(item.tenSp, query)}</strong><br>
                                                <small class="text-danger">${item.gia.toLocaleString()} ₫</small>
                                            </div>
                                        </div>
                                    `;
                                    li.onclick = () => {
                                        window.location.href = `/Product/Details/${item.maSp}`;
                                    };
                                    suggestionList.appendChild(li);
                                });
                                suggestionBox.style.display = 'block';
                            } else {
                                suggestionList.innerHTML = '<li class="list-group-item text-muted">Không tìm thấy sản phẩm</li>';
                                suggestionBox.style.display = 'block';
                            }
                        })
                        .catch(() => {
                            suggestionList.innerHTML = '<li class="list-group-item text-danger">Lỗi kết nối</li>';
                            suggestionBox.style.display = 'block';
                        });
                }, 300);
            });

            // Ẩn khi click ra ngoài
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !suggestionBox.contains(e.target)) {
                    suggestionBox.style.display = 'none';
                }
            });

            // Highlight từ khóa
            function highlight(text, query) {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<mark class="bg-warning">$1</mark>');
            }
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>